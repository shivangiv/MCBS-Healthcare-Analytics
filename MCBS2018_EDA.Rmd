---
title: "ALY6160_GroupProject"
author: "Catherine Richard, Shivangi Vashi"
date: "2/6/2021"
output: html_notebook
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set( warning=FALSE, message=FALSE)
```

### Cost Burden 


```{r}
library(data.table) 
library(tidyverse)
library(dplyr)
library(ggplot2)
library(skimr)

fall18<-fread("MCBSPUF18/puf2018_1_fall.csv") 
fall18<-as.data.frame(fall18)
summer18<-fread("MCBSPUF18/puf2018_3_summer.csv")


fall18_reformatted <-fread("MCBSPUF18/PUF_1_FALL_reformatted.csv")


#ageclass=ADM_H_MEDSTA, insurance_type: Adm_op,dual etc

```




```{r}
dim(fall18)

fall18<-fall18[,c(1,4:239)]
summer18<-summer18[,c(1,4:37)]

dim(fall18)


# colnames(fall18)
head(fall18)

fall18_reformatted  <- fall18_reformatted  %>%
 select(-SURVEYYR, -VERSION, -PUF_ID)
```


### Preprocessing

Data Dictionary:

ADM_H_MEDSTA: 1: elderly or 2: disabled or  3: unknown
ADM_H_GHPSW: 1: anyMA 0: no
ADM_H_PDRS: retiree drug subsidy(RDS) 1:not subsidized, 2: sub part year 3: sub full year, .:N/A, missing

insurance supplement type hierarchy being "Medicaid">"MAdv">"FFSwESI">"FFSwSelf">"FFSnoSupp"*/


```{r}
#Insurance Type
fall18<-fall18%>%
            mutate(ins_type=case_when(
                  ADM_DUAL_FLAG_YR%in%c(2,3) ~ "Medicaid" ,
                  INS_D_MADV==1 ~"MAdv",
                  INS_D_PVESI==1&ADM_FFS_FLAG_YR%in%c(2,3)~"FFSwESI",
                  INS_D_PVSELF==1&ADM_FFS_FLAG_YR%in%c(2,3)~"FFSwSelf",
                  ADM_FFS_FLAG_YR%in%c(2,3)&INS_D_MADV==2&INS_D_PVESI==2&INS_D_PVSELF==2~"OnlyFFS",
                    TRUE ~"Missing"))



```


Demograhpics:

DEM_AGE: 1: disabled, 2: 65-74 3: elderly >=75 

new col: 'ageclass' 1: disabled 2: elderly

DEM_SEX: 1:male 2: female

DEM_RACE: 1:non hisp white 2: non hisp black 3: hisp 4: other

DEM_EDU: 1: no hs 2: hs / vocational/tech/business
3: more than hs

DEM_MARSTA: 1: married 2: widowed 3: divorced/separated 4:never married

new col 'marital_status': 1: married 2: widowed 3: single
DEM_INCOME: 1: <25k, 2:>=25k

DEM_CBSA: 1: metro 2: non-metro


ACC_HCDELAY: 1: yes 2:no
```{r}

#Creating new columns Ageclass and marital status
fall18<-fall18%>%
  mutate(ageclass=ifelse(fall18$DEM_AGE==1,1,2))%>%
  mutate(
    marital_status=ifelse(DEM_MARSTA==1,1,
                          ifelse(DEM_MARSTA==2,2,
                                 ifelse(DEM_MARSTA%in%c(3,4),3,0)
                                 )
                          )
        )
fall18<-fall18%>%select(-DEM_MARSTA)

#checking unieuq values for each variable
# lapply(fall18[,-1], unique)

#Clean non response
fall18<-fall18%>%
      mutate_all(~ replace(.,.%in%c("D","R","",""), 99))%>%mutate_all(~replace_na(.,99))



summer18<-summer18%>%
      mutate_all(~ replace(.,.%in%c("D","R",""), 99))%>%mutate_all(~replace_na(.,99))
dim(fall18)



# lapply(fall18,typeof)

#change char to num
fall18<-fall18%>%mutate_if(is.character,as.numeric) 
fall18




# summer18<-summer18%>%mutate_if(is.character,as.numeric)

```

so for ex: 
if sum(fall18$ACC_HCTROUBL==99)/nrow(fall18) is <1.0
then fall18<-fall18[fall18$ACC_HCTROUBL!=99]
```{r}

#Removing NAs from variables of interest if %NA is small
removeNA<-function(v,df){
  x<-sum(df[v]==99)/nrow(df)
  if(x<0.01&&x!=0){
   df<-df%>%filter(df[v]!=99)
  }
  return (df)
}

# fall18<-removeNA(fall18[,50],fall18)
# nacols<-colnames(fall18[,c(38:40,42:43,46:48,50:51)])

for(i in names(fall18)){
  fall18<-removeNA(i,fall18)
 }

# 
# 
# fall18<-fall18[fall18$ACC_HCDELAY!=99,]
# fall18<-fall18[fall18$ACC_HCTROUBL!=99,]
# fall18<-fall18[fall18$ACC_PAYPROB!=99,]
# fall18<-fall18[fall18$DEM_EDU!=99,]

```




```{r}

#Column names for checking comorbidities

cardio<-c("HLT_OCARTERY","HLT_OCMYOCAR","HLT_OCCHD","HLT_OCCFAIL","HLT_OCHRTCND")
arthritis<-c("HLT_OCARTHRH","HLT_OCARTHOT","HLT_OCOSARTH")
cancer<-c("HLT_OCCANCER","HLT_OCCSKIN")
cvd<-c("HLT_OCARTERY","HLT_OCMYOCAR","HLT_OCCHD","HLT_OCCFAIL","HLT_OCHBP","HLT_OCSTROKE")
mentpsych<-c("HLT_OCPSYCHO","HLT_OCDEPRSS")

#Function to flag 1 if patient experiences any of the conditions
flag<-function(cols){
  f = ifelse(apply(fall18[cols]!=1&fall18[cols]!=2, 1, all), 99, 
                               ifelse(apply(fall18[cols]==1,1,any),1,0))
  return(f)
} 


flags<-matrix(nrow=11432, ncol = 7)
flags[,1]<-flag(cardio)
flags[,2]<-flag(arthritis)
flags[,3]<-flag(cancer)
flags[,4]<-flag(cvd)
flags[,5]<-flag(mentpsych)
flags[,6]<-ifelse(fall18$HLT_OCBETES==1,1,0)
flags[,7]<-ifelse(fall18$HLT_OCEMPHYS==1,1,0)


fall18<-fall18%>%mutate(totalcomorb =
                          ifelse(apply(flags!=99&flags!=2, 1, any),
                                 rowSums(flags), 0)
                        )
fall18<-select(fall18,-c(all_of(cardio),all_of(cancer),all_of(arthritis),all_of(cvd),all_of(mentpsych),"HLT_OCBETES","HLT_OCEMPHYS"))


```




# flag for checking whether insurance was not accepted by doc

Variables of significance:
MA_MADVYRS- those who have MCD for longer, do they have more costs?

```{r}

```


### Exploratory Data Analysis
```{r}
# Age groups suffering from hcdelay
fall18 %>%
  group_by(DEM_AGE,ACC_HCDELAY) %>%
  summarise(population=n())%>%
  ggplot( aes(x = DEM_AGE, y = population, fill = ACC_HCDELAY)) + 
  geom_col(position = "fill")




```


```{r}

df<-data.frame(table(fall18$ins_type,fall18$ACC_HCDELAY))
names(df) <- c("ins_type","ACC_HCDELAY","Count")
df
table(fall18$ACC_HCDELAY)

# fall18 %>% 
#   filter(fall18$MA_MADVYRS!=99&fall18$ACC_HCDELAY!=99)%>%
#   group_by(MA_MADVYRS, ACC_HCDELAY) %>% 
#   summarise(total_weight = sum(PUFFWGT)) %>% 
#   ggplot(aes(x = MA_MADVYRS, fill = ACC_HCDELAY, y =total_weight)) +
#   geom_bar(stat = "identity", position = "dodge")



```

```{r fig.width=12}
library(GGally)
library(ggparallel)

fall18$ACC_HCDELAY<-as.factor(fall18$ACC_HCDELAY)

colnames(fall18)
ggparcoord(fall18,columns=c(236,36:38,40:41,44:46,49),groupColumn =48,scale="globalminmax")

fall18[,c(38:40,42:43,46:48,50:51)]

```


```{r}
fall18[fall18$ACC_HCDELAY!=99,]%>%table(fall18$DEM_AGE,fall18$ACC_HCDELAY)
  ggplot(aes(x=DEM_AGE,fill=ACC_HCDELAY))+geom_bar(stat="count")

fall18%>%
  filter(fall18$MA_MADVYRS!=99&fall18$ACC_HCDELAY!=99)%>%
  ggplot(aes(x =MA_MADVYRS,fill = ACC_HCDELAY, y = PUFFWGT))+
  stat_summary(geom = "col", position = "dodge", fun = sum)


df[df$ACC_HCDELAY!=99,]%>%
  ggplot(aes(x=ins_type, y=Count, fill=ACC_HCDELAY))+geom_bar(stat="identity")



table(fall18$ins_type)
fall18$HCDELAY<-fall18$ACC_HCDELAY*fall18$PUFFWGT

fall18%>%ggplot(aes(y=ageclass))+geom_bar(stat = "count")+coord_flip()
fall18%>%ggplot(aes(y=ins_type))+geom_bar(stat = "count")+coord_flip()

fall18_reformatted%>%ggplot(aes(y=DEM_Race))+geom_bar(stat = "count")+coord_flip()

fall18 %>%
  group_by(DEM_AGE, DEM_INCOME) %>%
  summarise(total_weight = sum(PUFFWGT)) %>%
  ggplot(aes(x = DEM_AGE, fill = DEM_INCOME, y =total_weight)) +
  geom_bar(stat = "identity", position = "dodge")


fall18_reformatted$PUFFWGT<-fall18$PUFFWGT


fall18_reformatted %>%
  group_by(DEM_AGE, DEM_INCOME) %>%
  summarise(total_weight = sum(PUFFWGT)) %>%
  ggplot(aes(x = DEM_AGE, fill = DEM_INCOME, y =total_weight)) +
  geom_bar(stat = "identity", position = "dodge")




fall18_reformatted %>%filter(fall18_reformatted$MA_MADVYRS!="Inapplicable/Missing")%>%
  group_by(MA_MADVYRS, ACC_HCDELAY) %>%
  summarise(total_weight = sum(PUFFWGT)) %>%
  ggplot(aes(x = MA_MADVYRS, fill = ACC_HCDELAY, y =total_weight)) +
  geom_bar(stat = "identity", position = "dodge")


colnames(fall18)
table(fall18$ACC_PAYPROB)

fall18[,c(30:49,51,53:54,236)]%>%filter_at(vars(ACC_HCDELAY,ACC_COLAGNCY,MA_MADVYRS),all_vars(.!=99))%>%cor()%>%ggcorrplot::ggcorrplot()
```

#### Correlation Analysis
```{r}

fallsum<-inner_join(fall18,summer18,by="PUF_ID")

fallsum[,c(38:49,51,53:54,236,241:244,262:269)]%>%cor()%>%ggcorrplot::ggcorrplot()

colnames(fallsum)
```

##Univariate Analysis


Distribution of income, poverty line
DEM_INCOME:
DEM_INCOME: 1: <25k, 2:>=25k

Poverty Line:
"1: <=100% of the Federal Poverty Level" 
"2: >100% and <=120% of the Federal Poverty"
"3: >120% and <=135% of the Federal Poverty"
"4: >135% and <=200% of the Federal Poverty"
"5: >200% of the Federal Poverty Level"


```{r message=FALSE}
fall18%>%ggplot(aes(x=DEM_INCOME,y=PUFFWGT))+geom_col(color="blue")

fall18%>%ggplot(aes(x=DEM_IPR_IND,y=PUFFWGT))+geom_col(color="blue")

fall18%>%ggplot(aes(x=DEM_CBSA,y=PUFFWGT))+geom_col(color="blue")

```
HCDELAY, PAYPROB
1- yes 2- No


```{r warning=FALSE, message=FALSE}

fall18%>%ggplot(aes(x=factor(ACC_HCDELAY),y=PUFFWGT))+geom_boxplot() + geom_jitter() + theme_bw()


```

